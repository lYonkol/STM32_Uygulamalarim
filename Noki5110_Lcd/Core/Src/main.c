/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "math.h"
#include <stdio.h>
/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */

/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define LCD_RST_PORT GPIOA
#define LCD_RST_PIN  GPIO_PIN_0
#define LCD_CE_PORT  GPIOA
#define LCD_CE_PIN   GPIO_PIN_1
#define LCD_DC_PORT  GPIOA
#define LCD_DC_PIN   GPIO_PIN_2

#define SHT31_ADDR (0x44 << 1)
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
I2C_HandleTypeDef hi2c1;

SPI_HandleTypeDef hspi1;

/* USER CODE BEGIN PV */
const uint8_t ASCII[][5] = {
		0x00, 0x00, 0x00, 0x00, 0x00,  // 0x00 (nul)
			0x3E, 0x5B, 0x4F, 0x5B, 0x3E,  // 0x01 (soh)
			0x3E, 0x6B, 0x4F, 0x6B, 0x3E,  // 0x02 (stx)
			0x1C, 0x3E, 0x7C, 0x3E, 0x1C,  // 0x03 (etx)
			0x18, 0x3C, 0x7E, 0x3C, 0x18,  // 0x04 (eot)
			0x1C, 0x57, 0x7D, 0x57, 0x1C,  // 0x05 (enq)
			0x1C, 0x5E, 0x7F, 0x5E, 0x1C,  // 0x06 (ack)
			0x00, 0x18, 0x3C, 0x18, 0x00,  // 0x07 (bel)
			0xFF, 0xE7, 0xC3, 0xE7, 0xFF,  // 0x08 (bs)
			0x00, 0x18, 0x24, 0x18, 0x00,  // 0x09 (tab)
			0xFF, 0xE7, 0xDB, 0xE7, 0xFF,  // 0x0A (lf)
			0x30, 0x48, 0x3A, 0x06, 0x0E,  // 0x0B (vt)
			0x26, 0x29, 0x79, 0x29, 0x26,  // 0x0C (np)
			0x40, 0x7F, 0x05, 0x05, 0x07,  // 0x0D (cr)
			0x40, 0x7F, 0x05, 0x25, 0x3F,  // 0x0E (so)
			0x5A, 0x3C, 0xE7, 0x3C, 0x5A,  // 0x0F (si)
			0x7F, 0x3E, 0x1C, 0x1C, 0x08,  // 0x10 (dle)
			0x08, 0x1C, 0x1C, 0x3E, 0x7F,  // 0x11 (dc1)
			0x14, 0x22, 0x7F, 0x22, 0x14,  // 0x12 (dc2)
			0x5F, 0x5F, 0x00, 0x5F, 0x5F,  // 0x13 (dc3)
			0x06, 0x09, 0x7F, 0x01, 0x7F,  // 0x14 (dc4)
			0x00, 0x66, 0x89, 0x95, 0x6A,  // 0x15 (nak)
			0x60, 0x60, 0x60, 0x60, 0x60,  // 0x16 (syn)
			0x94, 0xA2, 0xFF, 0xA2, 0x94,  // 0x17 (etb)
			0x08, 0x04, 0x7E, 0x04, 0x08,  // 0x18 (can)
			0x10, 0x20, 0x7E, 0x20, 0x10,  // 0x19 (em)
			0x08, 0x08, 0x2A, 0x1C, 0x08,  // 0x1A (eof)
			0x08, 0x1C, 0x2A, 0x08, 0x08,  // 0x1B (esc)
			0x1E, 0x10, 0x10, 0x10, 0x10,  // 0x1C (fs)
			0x0C, 0x1E, 0x0C, 0x1E, 0x0C,  // 0x1D (gs)
			0x30, 0x38, 0x3E, 0x38, 0x30,  // 0x1E (rs)
			0x06, 0x0E, 0x3E, 0x0E, 0x06,  // 0x1F (us)
			0x00, 0x00, 0x00, 0x00, 0x00,  // 0x20
			0x00, 0x00, 0x5F, 0x00, 0x00,  // 0x21 !
			0x00, 0x07, 0x00, 0x07, 0x00,  // 0x22 "
			0x14, 0x7F, 0x14, 0x7F, 0x14,  // 0x23 #
			0x24, 0x2A, 0x7F, 0x2A, 0x12,  // 0x24 $
			0x23, 0x13, 0x08, 0x64, 0x62,  // 0x25 %
			0x36, 0x49, 0x56, 0x20, 0x50,  // 0x26 &
			0x00, 0x08, 0x07, 0x03, 0x00,  // 0x27 '
			0x00, 0x1C, 0x22, 0x41, 0x00,  // 0x28 (
			0x00, 0x41, 0x22, 0x1C, 0x00,  // 0x29 )
			0x2A, 0x1C, 0x7F, 0x1C, 0x2A,  // 0x2A *
			0x08, 0x08, 0x3E, 0x08, 0x08,  // 0x2B +
			0x00, 0x80, 0x70, 0x30, 0x00,  // 0x2C ,
			0x08, 0x08, 0x08, 0x08, 0x08,  // 0x2D -
			0x00, 0x00, 0x60, 0x60, 0x00,  // 0x2E .
			0x20, 0x10, 0x08, 0x04, 0x02,  // 0x2F /
			0x3E, 0x51, 0x49, 0x45, 0x3E,  // 0x30 0
			0x00, 0x42, 0x7F, 0x40, 0x00,  // 0x31 1
			0x72, 0x49, 0x49, 0x49, 0x46,  // 0x32 2
			0x21, 0x41, 0x49, 0x4D, 0x33,  // 0x33 3
			0x18, 0x14, 0x12, 0x7F, 0x10,  // 0x34 4
			0x27, 0x45, 0x45, 0x45, 0x39,  // 0x35 5
			0x3C, 0x4A, 0x49, 0x49, 0x31,  // 0x36 6
			0x41, 0x21, 0x11, 0x09, 0x07,  // 0x37 7
			0x36, 0x49, 0x49, 0x49, 0x36,  // 0x38 8
			0x46, 0x49, 0x49, 0x29, 0x1E,  // 0x39 9
			0x00, 0x00, 0x14, 0x00, 0x00,  // 0x3A :
			0x00, 0x40, 0x34, 0x00, 0x00,  // 0x3B ;
			0x00, 0x08, 0x14, 0x22, 0x41,  // 0x3C <
			0x14, 0x14, 0x14, 0x14, 0x14,  // 0x3D =
			0x00, 0x41, 0x22, 0x14, 0x08,  // 0x3E >
			0x02, 0x01, 0x59, 0x09, 0x06,  // 0x3F ?
			0x3E, 0x41, 0x5D, 0x59, 0x4E,  // 0x40 @
			0x7C, 0x12, 0x11, 0x12, 0x7C,  // 0x41 A
			0x7F, 0x49, 0x49, 0x49, 0x36,  // 0x42 B
			0x3E, 0x41, 0x41, 0x41, 0x22,  // 0x43 C
			0x7F, 0x41, 0x41, 0x41, 0x3E,  // 0x44 D
			0x7F, 0x49, 0x49, 0x49, 0x41,  // 0x45 E
			0x7F, 0x09, 0x09, 0x09, 0x01,  // 0x46 F
			0x3E, 0x41, 0x41, 0x51, 0x73,  // 0x47 G
			0x7F, 0x08, 0x08, 0x08, 0x7F,  // 0x48 H
			0x00, 0x41, 0x7F, 0x41, 0x00,  // 0x49 I
			0x20, 0x40, 0x41, 0x3F, 0x01,  // 0x4A J
			0x7F, 0x08, 0x14, 0x22, 0x41,  // 0x4B K
			0x7F, 0x40, 0x40, 0x40, 0x40,  // 0x4C L
			0x7F, 0x02, 0x1C, 0x02, 0x7F,  // 0x4D M
			0x7F, 0x04, 0x08, 0x10, 0x7F,  // 0x4E N
			0x3E, 0x41, 0x41, 0x41, 0x3E,  // 0x4F O
			0x7F, 0x09, 0x09, 0x09, 0x06,  // 0x50 P
			0x3E, 0x41, 0x51, 0x21, 0x5E,  // 0x51 Q
			0x7F, 0x09, 0x19, 0x29, 0x46,  // 0x52 R
			0x26, 0x49, 0x49, 0x49, 0x32,  // 0x53 S
			0x03, 0x01, 0x7F, 0x01, 0x03,  // 0x54 T
			0x3F, 0x40, 0x40, 0x40, 0x3F,  // 0x55 U
			0x1F, 0x20, 0x40, 0x20, 0x1F,  // 0x56 V
			0x3F, 0x40, 0x38, 0x40, 0x3F,  // 0x57 W
			0x63, 0x14, 0x08, 0x14, 0x63,  // 0x58 X
			0x03, 0x04, 0x78, 0x04, 0x03,  // 0x59 Y
			0x61, 0x59, 0x49, 0x4D, 0x43,  // 0x5A Z
			0x00, 0x7F, 0x41, 0x41, 0x41,  // 0x5B [
			0x02, 0x04, 0x08, 0x10, 0x20,  // 0x5C backslash
			0x00, 0x41, 0x41, 0x41, 0x7F,  // 0x5D ]
			0x04, 0x02, 0x01, 0x02, 0x04,  // 0x5E ^
			0x40, 0x40, 0x40, 0x40, 0x40,  // 0x5F _
			0x00, 0x03, 0x07, 0x08, 0x00,  // 0x60 `
			0x20, 0x54, 0x54, 0x78, 0x40,  // 0x61 a
			0x7F, 0x28, 0x44, 0x44, 0x38,  // 0x62 b
			0x38, 0x44, 0x44, 0x44, 0x28,  // 0x63 c
			0x38, 0x44, 0x44, 0x28, 0x7F,  // 0x64 d
			0x38, 0x54, 0x54, 0x54, 0x18,  // 0x65 e
			0x00, 0x08, 0x7E, 0x09, 0x02,  // 0x66 f
			0x18, 0xA4, 0xA4, 0x9C, 0x78,  // 0x67 g
			0x7F, 0x08, 0x04, 0x04, 0x78,  // 0x68 h
			0x00, 0x44, 0x7D, 0x40, 0x00,  // 0x69 i
			0x20, 0x40, 0x40, 0x3D, 0x00,  // 0x6A j
			0x7F, 0x10, 0x28, 0x44, 0x00,  // 0x6B k
			0x00, 0x41, 0x7F, 0x40, 0x00,  // 0x6C l
			0x7C, 0x04, 0x78, 0x04, 0x78,  // 0x6D m
			0x7C, 0x08, 0x04, 0x04, 0x78,  // 0x6E n
			0x38, 0x44, 0x44, 0x44, 0x38,  // 0x6F o
			0xFC, 0x18, 0x24, 0x24, 0x18,  // 0x70 p
			0x18, 0x24, 0x24, 0x18, 0xFC,  // 0x71 q
			0x7C, 0x08, 0x04, 0x04, 0x08,  // 0x72 r
			0x48, 0x54, 0x54, 0x54, 0x24,  // 0x73 s
			0x04, 0x04, 0x3F, 0x44, 0x24,  // 0x74 t
			0x3C, 0x40, 0x40, 0x20, 0x7C,  // 0x75 u
			0x1C, 0x20, 0x40, 0x20, 0x1C,  // 0x76 v
			0x3C, 0x40, 0x30, 0x40, 0x3C,  // 0x77 w
			0x44, 0x28, 0x10, 0x28, 0x44,  // 0x78 x
			0x4C, 0x90, 0x90, 0x90, 0x7C,  // 0x79 y
			0x44, 0x64, 0x54, 0x4C, 0x44,  // 0x7A z
			0x00, 0x08, 0x36, 0x41, 0x00,  // 0x7B {
			0x00, 0x00, 0x77, 0x00, 0x00,  // 0x7C |
			0x00, 0x41, 0x36, 0x08, 0x00,  // 0x7D }
			0x02, 0x01, 0x02, 0x04, 0x02,  // 0x7E ~
			0x3C, 0x26, 0x23, 0x26, 0x3C,  // 0x7F
			0x1E, 0xA1, 0xA1, 0x61, 0x12,  // 0x80
			0x3A, 0x40, 0x40, 0x20, 0x7A,  // 0x81
			0x38, 0x54, 0x54, 0x55, 0x59,  // 0x82
			0x21, 0x55, 0x55, 0x79, 0x41,  // 0x83
			0x22, 0x54, 0x54, 0x78, 0x42,  // 0x84
			0x21, 0x55, 0x54, 0x78, 0x40,  // 0x85
			0x20, 0x54, 0x55, 0x79, 0x40,  // 0x86
			0x0C, 0x1E, 0x52, 0x72, 0x12,  // 0x87
			0x39, 0x55, 0x55, 0x55, 0x59,  // 0x88
			0x39, 0x54, 0x54, 0x54, 0x59,  // 0x89
			0x39, 0x55, 0x54, 0x54, 0x58,  // 0x8A
			0x00, 0x00, 0x45, 0x7C, 0x41,  // 0x8B
			0x00, 0x02, 0x45, 0x7D, 0x42,  // 0x8C
			0x00, 0x01, 0x45, 0x7C, 0x40,  // 0x8D
			0x7D, 0x12, 0x11, 0x12, 0x7D,  // 0x8E
			0xF0, 0x28, 0x25, 0x28, 0xF0,  // 0x8F
			0x7C, 0x54, 0x55, 0x45, 0x00,  // 0x90
			0x20, 0x54, 0x54, 0x7C, 0x54,  // 0x91
			0x7C, 0x0A, 0x09, 0x7F, 0x49,  // 0x92
			0x32, 0x49, 0x49, 0x49, 0x32,  // 0x93
			0x3A, 0x44, 0x44, 0x44, 0x3A,  // 0x94
			0x32, 0x4A, 0x48, 0x48, 0x30,  // 0x95
			0x3A, 0x41, 0x41, 0x21, 0x7A,  // 0x96
			0x3A, 0x42, 0x40, 0x20, 0x78,  // 0x97
			0x00, 0x9D, 0xA0, 0xA0, 0x7D,  // 0x98
			0x3D, 0x42, 0x42, 0x42, 0x3D,  // 0x99
			0x3D, 0x40, 0x40, 0x40, 0x3D,  // 0x9A
			0x3C, 0x24, 0xFF, 0x24, 0x24,  // 0x9B
			0x48, 0x7E, 0x49, 0x43, 0x66,  // 0x9C
			0x2B, 0x2F, 0xFC, 0x2F, 0x2B,  // 0x9D
			0xFF, 0x09, 0x29, 0xF6, 0x20,  // 0x9E
			0xC0, 0x88, 0x7E, 0x09, 0x03,  // 0x9F
			0x20, 0x54, 0x54, 0x79, 0x41,  // 0xA0
			0x00, 0x00, 0x44, 0x7D, 0x41,  // 0xA1
			0x30, 0x48, 0x48, 0x4A, 0x32,  // 0xA2
			0x38, 0x40, 0x40, 0x22, 0x7A,  // 0xA3
			0x00, 0x7A, 0x0A, 0x0A, 0x72,  // 0xA4
			0x7D, 0x0D, 0x19, 0x31, 0x7D,  // 0xA5
			0x26, 0x29, 0x29, 0x2F, 0x28,  // 0xA6
			0x26, 0x29, 0x29, 0x29, 0x26,  // 0xA7
			0x30, 0x48, 0x4D, 0x40, 0x20,  // 0xA8
			0x38, 0x08, 0x08, 0x08, 0x08,  // 0xA9
			0x08, 0x08, 0x08, 0x08, 0x38,  // 0xAA
			0x2F, 0x10, 0xC8, 0xAC, 0xBA,  // 0xAB
			0x2F, 0x10, 0x28, 0x34, 0xFA,  // 0xAC
			0x00, 0x00, 0x7B, 0x00, 0x00,  // 0xAD
			0x08, 0x14, 0x2A, 0x14, 0x22,  // 0xAE
			0x22, 0x14, 0x2A, 0x14, 0x08,  // 0xAF
			0x55, 0x00, 0x55, 0x00, 0x55,  // 0xB0
			0xAA, 0x55, 0xAA, 0x55, 0xAA,  // 0xB1
			0xFF, 0x55, 0xFF, 0x55, 0xFF,  // 0xB2
			0x00, 0x00, 0x00, 0xFF, 0x00,  // 0xB3
			0x10, 0x10, 0x10, 0xFF, 0x00,  // 0xB4
			0x14, 0x14, 0x14, 0xFF, 0x00,  // 0xB5
			0x10, 0x10, 0xFF, 0x00, 0xFF,  // 0xB6
			0x10, 0x10, 0xF0, 0x10, 0xF0,  // 0xB7
			0x14, 0x14, 0x14, 0xFC, 0x00,  // 0xB8
			0x14, 0x14, 0xF7, 0x00, 0xFF,  // 0xB9
			0x00, 0x00, 0xFF, 0x00, 0xFF,  // 0xBA
			0x14, 0x14, 0xF4, 0x04, 0xFC,  // 0xBB
			0x14, 0x14, 0x17, 0x10, 0x1F,  // 0xBC
			0x10, 0x10, 0x1F, 0x10, 0x1F,  // 0xBD
			0x14, 0x14, 0x14, 0x1F, 0x00,  // 0xBE
			0x10, 0x10, 0x10, 0xF0, 0x00,  // 0xBF
			0x00, 0x00, 0x00, 0x1F, 0x10,  // 0xC0
			0x10, 0x10, 0x10, 0x1F, 0x10,  // 0xC1
			0x10, 0x10, 0x10, 0xF0, 0x10,  // 0xC2
			0x00, 0x00, 0x00, 0xFF, 0x10,  // 0xC3
			0x10, 0x10, 0x10, 0x10, 0x10,  // 0xC4
			0x10, 0x10, 0x10, 0xFF, 0x10,  // 0xC5
			0x00, 0x00, 0x00, 0xFF, 0x14,  // 0xC6
			0x00, 0x00, 0xFF, 0x00, 0xFF,  // 0xC7
			0x00, 0x00, 0x1F, 0x10, 0x17,  // 0xC8
			0x00, 0x00, 0xFC, 0x04, 0xF4,  // 0xC9
			0x14, 0x14, 0x17, 0x10, 0x17,  // 0xCA
			0x14, 0x14, 0xF4, 0x04, 0xF4,  // 0xCB
			0x00, 0x00, 0xFF, 0x00, 0xF7,  // 0xCC
			0x14, 0x14, 0x14, 0x14, 0x14,  // 0xCD
			0x14, 0x14, 0xF7, 0x00, 0xF7,  // 0xCE
			0x14, 0x14, 0x14, 0x17, 0x14,  // 0xCF
			0x10, 0x10, 0x1F, 0x10, 0x1F,  // 0xD0
			0x14, 0x14, 0x14, 0xF4, 0x14,  // 0xD1
			0x10, 0x10, 0xF0, 0x10, 0xF0,  // 0xD2
			0x00, 0x00, 0x1F, 0x10, 0x1F,  // 0xD3
			0x00, 0x00, 0x00, 0x1F, 0x14,  // 0xD4
			0x00, 0x00, 0x00, 0xFC, 0x14,  // 0xD5
			0x00, 0x00, 0xF0, 0x10, 0xF0,  // 0xD6
			0x10, 0x10, 0xFF, 0x10, 0xFF,  // 0xD7
			0x14, 0x14, 0x14, 0xFF, 0x14,  // 0xD8
			0x10, 0x10, 0x10, 0x1F, 0x00,  // 0xD9
			0x00, 0x00, 0x00, 0xF0, 0x10,  // 0xDA
			0xFF, 0xFF, 0xFF, 0xFF, 0xFF,  // 0xDB
			0xF0, 0xF0, 0xF0, 0xF0, 0xF0,  // 0xDC
			0xFF, 0xFF, 0xFF, 0x00, 0x00,  // 0xDD
			0x00, 0x00, 0x00, 0xFF, 0xFF,  // 0xDE
			0x0F, 0x0F, 0x0F, 0x0F, 0x0F,  // 0xDF
			0x38, 0x44, 0x44, 0x38, 0x44,  // 0xE0
			0xFC, 0x4A, 0x4A, 0x4A, 0x34,  // 0xE1
			0x7E, 0x02, 0x02, 0x06, 0x06,  // 0xE2
			0x02, 0x7E, 0x02, 0x7E, 0x02,  // 0xE3
			0x63, 0x55, 0x49, 0x41, 0x63,  // 0xE4
			0x38, 0x44, 0x44, 0x3C, 0x04,  // 0xE5
			0x40, 0x7E, 0x20, 0x1E, 0x20,  // 0xE6
			0x06, 0x02, 0x7E, 0x02, 0x02,  // 0xE7
			0x99, 0xA5, 0xE7, 0xA5, 0x99,  // 0xE8
			0x1C, 0x2A, 0x49, 0x2A, 0x1C,  // 0xE9
			0x4C, 0x72, 0x01, 0x72, 0x4C,  // 0xEA
			0x30, 0x4A, 0x4D, 0x4D, 0x30,  // 0xEB
			0x30, 0x48, 0x78, 0x48, 0x30,  // 0xEC
			0xBC, 0x62, 0x5A, 0x46, 0x3D,  // 0xED
			0x3E, 0x49, 0x49, 0x49, 0x00,  // 0xEE
			0x7E, 0x01, 0x01, 0x01, 0x7E,  // 0xEF
			0x2A, 0x2A, 0x2A, 0x2A, 0x2A,  // 0xF0
			0x44, 0x44, 0x5F, 0x44, 0x44,  // 0xF1
			0x40, 0x51, 0x4A, 0x44, 0x40,  // 0xF2
			0x40, 0x44, 0x4A, 0x51, 0x40,  // 0xF3
			0x00, 0x00, 0xFF, 0x01, 0x03,  // 0xF4
			0xE0, 0x80, 0xFF, 0x00, 0x00,  // 0xF5
			0x08, 0x08, 0x6B, 0x6B, 0x08,  // 0xF6
			0x36, 0x12, 0x36, 0x24, 0x36,  // 0xF7
			0x06, 0x0F, 0x09, 0x0F, 0x06,  // 0xF8
			0x00, 0x00, 0x18, 0x18, 0x00,  // 0xF9
			0x00, 0x00, 0x10, 0x10, 0x00,  // 0xFA
			0x30, 0x40, 0xFF, 0x01, 0x01,  // 0xFB
			0x00, 0x1F, 0x01, 0x01, 0x1E,  // 0xFC
			0x00, 0x19, 0x1D, 0x17, 0x12,  // 0xFD
			0x00, 0x3C, 0x3C, 0x3C, 0x3C,  // 0xFE
			0x00, 0x00, 0x00, 0x00, 0x00   // 0xFF
};
const uint8_t icon_temp[8] = {
    0b00000000,
    0b00000000,
    0b01111100,
    0b01000100,
    0b01000100,
    0b01111100,
    0b00111000,
    0b00000000
};

const uint8_t icon_humidity[8] = {
    0b00010000,
    0b00111000,
    0b01111100,
    0b01111100,
    0b01111100,
    0b00111000,
    0b00010000,
    0b00000000
};




float temperature = 0.0f;
float humidity = 0.0f;
char buffer[32];
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_SPI1_Init(void);
static void MX_I2C1_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
void LCD_SendCommand(uint8_t cmd) {
    HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_RESET); // DC = 0
    HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_RESET); // CE = 0

    HAL_SPI_Transmit(&hspi1, &cmd, 1, HAL_MAX_DELAY);

    HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_SET);   // CE = 1
}

void LCD_SendData(uint8_t data) {
    HAL_GPIO_WritePin(LCD_DC_PORT, LCD_DC_PIN, GPIO_PIN_SET);   // DC = 1
    HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_RESET); // CE = 0

    HAL_SPI_Transmit(&hspi1, &data, 1, HAL_MAX_DELAY);

    HAL_GPIO_WritePin(LCD_CE_PORT, LCD_CE_PIN, GPIO_PIN_SET);   // CE = 1
}

void LCD_Clear(void) {
    // LCD'nin RAM'ini sıfırla (tüm piksel verisi 0x00)
    for (uint16_t i = 0; i < 504; i++) { // 84 x 48 / 8 = 504 byte
        LCD_SendData(0x00);
    }

    // İmleci başa al (optional)
    LCD_SendCommand(0x80); // X = 0
    LCD_SendCommand(0x40); // Y = 0
}

void LCD_Init(void) {
    // Reset işlemi
    HAL_GPIO_WritePin(LCD_RST_PORT, LCD_RST_PIN, GPIO_PIN_RESET);
    HAL_Delay(10);
    HAL_GPIO_WritePin(LCD_RST_PORT, LCD_RST_PIN, GPIO_PIN_SET);
    LCD_SendCommand(0x21); // Extended instruction set
    LCD_SendCommand(0xB1); // Vop = kontrast
    LCD_SendCommand(0x04); // Temperature Coefficient
    LCD_SendCommand(0x14); // Bias mode 1:48
    LCD_SendCommand(0x20); // Temel komut setine dön
    LCD_SendCommand(0x0C); // Normal display


    LCD_Clear();
}

void LCD_WriteChar(char character) {
    uint8_t index = (uint8_t)character;  // ASCII dizini direkt karakterin kendisi

    for (int i = 0; i < 5; i++) {
        LCD_SendData(ASCII[index][i]);
    }

    LCD_SendData(0x00); // boşluk
}

void LCD_WriteString(const char* str) {
    while (*str) {
        LCD_WriteChar(*str++);
    }
}
void LCD_SetCursor(uint8_t x, uint8_t y) {
    // x: 0 - 83, y: 0 - 5
    LCD_SendCommand(0x80 | x); // X adresi: 0x80 + x
    LCD_SendCommand(0x40 | y); // Y adresi: 0x40 + y
}

void LCD_DrawBitmap(const uint8_t* bitmap, uint8_t width, uint8_t height, uint8_t x, uint8_t y) {
    uint8_t rows = height / 8;

    for (uint8_t row = 0; row < rows; row++) {
        LCD_SetCursor(x, y + row);
        for (uint8_t col = 0; col < width; col++) {
            LCD_SendData(bitmap[row * width + col]);
        }
    }
}

void LCD_DrawIcon(const uint8_t* icon, uint8_t x, uint8_t y) {
    LCD_SetCursor(x, y);
    for (int i = 0; i < 8; i++) {
        LCD_SendData(icon[i]);
    }
}

void SHT31_ReadTempHum(void) {
    uint8_t cmd[2] = {0x2C, 0x06}; // ölçüm başlatma komutu
    uint8_t data[6]; // sıcaklık ve nem 6 byte

    HAL_I2C_Master_Transmit(&hi2c1, SHT31_ADDR, cmd, 2, HAL_MAX_DELAY);
    HAL_Delay(15); // ölçüm süresi için bekle (datasheet öneriyor)
    HAL_I2C_Master_Receive(&hi2c1, SHT31_ADDR, data, 6, HAL_MAX_DELAY);

    // Veri çözümleme
    uint16_t temp_raw = (data[0] << 8) | data[1];
    uint16_t hum_raw  = (data[3] << 8) | data[4];

    // Datasheet formülü
    temperature = -45 + 175 * ((float)temp_raw / 65535.0f);
    humidity = 100 * ((float)hum_raw / 65535.0f);
}

void LCD_DisplayTempHum(void) {
    int t_int = (int)temperature;
    int t_dec = (int)((temperature - t_int) * 10);
    int h_int = (int)humidity;
    int h_dec = (int)((humidity - h_int) * 10);

    LCD_Clear();

    // 🌡️ Sıcaklık
    LCD_DrawIcon(icon_temp, 0, 0);
    LCD_SetCursor(10, 0);
    sprintf(buffer, "%d.%dC", t_int, t_dec);
    LCD_WriteString(buffer);

    // 💧 Nem
    LCD_DrawIcon(icon_humidity, 0, 1);
    LCD_SetCursor(10, 1);
    sprintf(buffer, "%d.%d%%", h_int, h_dec);
    LCD_WriteString(buffer);
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_SPI1_Init();
  MX_I2C1_Init();
  /* USER CODE BEGIN 2 */
  LCD_Init();

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
      SHT31_ReadTempHum();
      LCD_DisplayTempHum();
      HAL_Delay(1000);
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 168;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief I2C1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2C1_Init(void)
{

  /* USER CODE BEGIN I2C1_Init 0 */

  /* USER CODE END I2C1_Init 0 */

  /* USER CODE BEGIN I2C1_Init 1 */

  /* USER CODE END I2C1_Init 1 */
  hi2c1.Instance = I2C1;
  hi2c1.Init.ClockSpeed = 100000;
  hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
  hi2c1.Init.OwnAddress1 = 0;
  hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
  hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
  hi2c1.Init.OwnAddress2 = 0;
  hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
  hi2c1.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
  if (HAL_I2C_Init(&hi2c1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2C1_Init 2 */

  /* USER CODE END I2C1_Init 2 */

}

/**
  * @brief SPI1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI1_Init(void)
{

  /* USER CODE BEGIN SPI1_Init 0 */

  /* USER CODE END SPI1_Init 0 */

  /* USER CODE BEGIN SPI1_Init 1 */

  /* USER CODE END SPI1_Init 1 */
  /* SPI1 parameter configuration*/
  hspi1.Instance = SPI1;
  hspi1.Init.Mode = SPI_MODE_MASTER;
  hspi1.Init.Direction = SPI_DIRECTION_2LINES;
  hspi1.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi1.Init.NSS = SPI_NSS_SOFT;
  hspi1.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_64;
  hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi1.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi1.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi1.Init.CRCPolynomial = 10;
  if (HAL_SPI_Init(&hspi1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI1_Init 2 */

  /* USER CODE END SPI1_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOA, RST_Pin|CE_Pin|DC_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pins : RST_Pin CE_Pin DC_Pin */
  GPIO_InitStruct.Pin = RST_Pin|CE_Pin|DC_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
